name: Deploy to AWS

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prod

permissions:
  id-token: write   # OIDC authentication required
  contents: read

jobs:
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine Target Environment
        id: determine-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # If manual trigger, use user-selected input (dev or prod)
            echo "TARGET_ENV=${{ inputs.environment }}" >> $GITHUB_ENV
            echo "Selected manual deployment to: ${{ inputs.environment }}"
          else
            # If Push to main, force deployment to dev
            echo "TARGET_ENV=dev" >> $GITHUB_ENV
            echo "Push event detected. Defaulting deployment to: dev"
          fi

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
          enable-cache: true

      - name: Install AWS CDK CLI
        run: |
          npm install -g aws-cdk

      - name: Install project dependencies with uv
        run: |
          uv sync --frozen

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-central-1

      - name: Verify CDK installation
        run: |
          uv run cdk --version

      - name: CDK Bootstrap (usually only needs to run once, but kept here as a safeguard)
        working-directory: ./infra
        env:
          TELEGRAM_BOT_TOKEN: ${{ env.TARGET_ENV == 'prod' && secrets.PROD_TELEGRAM_BOT_TOKEN || secrets.DEV_TELEGRAM_BOT_TOKEN }}
          TELEGRAM_WEBHOOK_SECRET_TOKEN: ${{ env.TARGET_ENV == 'prod' && secrets.PROD_TELEGRAM_WEBHOOK_SECRET_TOKEN || secrets.DEV_TELEGRAM_WEBHOOK_SECRET_TOKEN }}
        run: |
          uv run cdk bootstrap aws://$(aws sts get-caller-identity --query Account --output text)/eu-central-1 || echo "Bootstrap may already be done"
        continue-on-error: true

      - name: CDK Deploy
        working-directory: ./infra
        env:
          TELEGRAM_BOT_TOKEN: ${{ env.TARGET_ENV == 'prod' && secrets.PROD_TELEGRAM_BOT_TOKEN || secrets.DEV_TELEGRAM_BOT_TOKEN }}
          TELEGRAM_WEBHOOK_SECRET_TOKEN: ${{ env.TARGET_ENV == 'prod' && secrets.PROD_TELEGRAM_WEBHOOK_SECRET_TOKEN || secrets.DEV_TELEGRAM_WEBHOOK_SECRET_TOKEN }}
        run: |
          echo "ðŸš€ Deploying to ${{ env.TARGET_ENV }} environment..."
          uv run cdk deploy -c env=${{ env.TARGET_ENV }} --require-approval never --all

      - name: Get Deployment Outputs
        if: success()
        working-directory: ./infra
        run: |
          echo "## ðŸš€ Deployment Successful (Zerde Telegram Bot)" >> $GITHUB_STEP_SUMMARY
          echo "Deployed to: **${{ env.TARGET_ENV }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Stack Outputs:" >> $GITHUB_STEP_SUMMARY

          # Get the stack name based on the environment (ZerdeTelegramBotStack-dev or ZerdeTelegramBotStack-prod)
          STACK_NAME="ZerdeTelegramBotStack-${{ env.TARGET_ENV }}"

          aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --region eu-central-1 \
            --query 'Stacks[0].Outputs[*].[OutputKey,OutputValue]' \
            --output table >> $GITHUB_STEP_SUMMARY || echo "Could not fetch outputs" >> $GITHUB_STEP_SUMMARY
